{# campaign_detail.html
   Detail view for a single campaign.

   Displays campaign metadata (channel, objective, dates, budget) and
   lists all posts that belong to the campaign, with links to view each
   post, add a new post or edit the campaign.
#}

{% extends 'project/base.html' %}

{% block content %}
<div class="row mb-4">
  <div class="col-md-8">
    <h1 class="h3 mb-1">{{ campaign.name }}</h1>
    <p class="text-muted-soft mb-2">
      {{ campaign.channel.name }} · {{ campaign.objective.name }}
    </p>
  </div>

  <div class="col-md-4 text-md-end">
    <a href="{% url 'project:campaign_update' campaign.pk %}"
       class="btn btn-outline-light btn-sm me-2">
      Edit campaign
    </a>
    <a href="{% url 'project:post_create' %}"
       class="btn btn-accent btn-sm">
      + New Post
    </a>
  </div>
</div>

<div class="row g-4">
  <!-- Summary card -->
  <div class="col-md-5">
    <div class="card card-cl">
      <div class="card-body">
        <h2 class="h6 text-muted-soft mb-3">Campaign summary</h2>
        <p class="mb-2">
          <strong>Channel:</strong>
          <span class="badge badge-channel ms-1">
            {{ campaign.channel.name }}
          </span>
        </p>
        <p class="mb-2">
          <strong>Objective:</strong>
          <span class="badge badge-objective ms-1">
            {{ campaign.objective.name }}
          </span>
        </p>
        <p class="mb-2">
          <strong>Dates:</strong>
          {{ campaign.start_date }} – {{ campaign.end_date }}
        </p>
        <p class="mb-0">
          <strong>Budget:</strong>
          ${{ campaign.budget }}
        </p>
      </div>
    </div>
  </div>

  <!-- Posts list -->
  <div class="col-md-7">
    <div class="card card-cl">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h2 class="h6 text-muted-soft mb-0">Posts in this campaign</h2>
        </div>

        {% if campaign.posts.all %}
          <div class="list-group list-group-flush">
            {% for post in campaign.posts.all %}
              <a href="{% url 'project:post_detail' post.pk %}"
                 class="list-group-item list-group-item-action bg-transparent text-light border-secondary">
                <div class="d-flex justify-content-between">
                  <div>
                    <div>
                      {{ post.post_date }} · {{ post.get_content_type_display }}
                    </div>
                    <div class="text-muted-soft">
                      {{ post.caption|truncatechars:80 }}
                    </div>
                  </div>
                </div>
              </a>
            {% endfor %}
          </div>
        {% else %}
          <p class="mt-3 text-muted-soft">
            No posts for this campaign yet.
          </p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

  {# Graph #}
<div class="row mb-4">
  <div class="col-12">
    <div class="card card-cl p-4">
      <h2 class="h5 mb-3 page-title">Campaign performance overview</h2>
      <p class="text-muted-soft mb-4">
        Visual summary of impressions, clicks and engagement for each post in this campaign.
      </p>

      <div class="chart-wrapper" style="height:260px; position:relative;">
        <canvas id="campaignPerformanceChart"></canvas>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  (function () {
    const labels = {{ chart_labels|default:"[]" }};
    const impressions = {{ chart_impressions|default:"[]" }};
    const clicks = {{ chart_clicks|default:"[]" }};
    const engagement = {{ chart_engagement|default:"[]" }};

    const ctx = document.getElementById('campaignPerformanceChart');
    if (!ctx || labels.length === 0) {
      return;
    }

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            type: 'bar',
            label: 'Impressions',
            data: impressions,
            // sin colores específicos -> Chart.js usa los por defecto
          },
          {
            type: 'bar',
            label: 'Clicks',
            data: clicks,
          },
          {
            type: 'line',
            label: 'Engagement rate',
            data: engagement,
            yAxisID: 'y1',
            tension: 0.3,
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: {
              color: '#e5e7eb'
            }
          }
        },
        scales: {
          x: {
            ticks: { color: '#e5e7eb' },
            grid: { display: false }
          },
          y: {
            position: 'left',
            ticks: { color: '#e5e7eb' },
            grid: { color: 'rgba(148, 163, 184, 0.25)' }
          },
          y1: {
            position: 'right',
            ticks: { color: '#e5e7eb' },
            grid: { drawOnChartArea: false }
          }
        }
      }
    });
  })();
</script>
{% endblock %}
